<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 900 550">
  <!-- Pure black background -->
  <rect width="900" height="550" fill="#000000"/>

  <!-- Title -->
  <text x="450" y="35" font-family="CMU Serif, Georgia, serif" font-size="24" fill="#ffffff" text-anchor="middle">Causal Linear Attention: Cumulative Sum</text>

  <!-- Subtitle -->
  <text x="450" y="58" font-family="CMU Serif, Georgia, serif" font-size="14" fill="#888888" text-anchor="middle">
    Position i only sees positions j ≤ i — Use cumsum for efficient computation
  </text>

  <!-- ============ Causal Mask Illustration ============ -->
  <g transform="translate(50, 90)">
    <text x="100" y="-5" font-family="CMU Serif, Georgia, serif" font-size="16" fill="#FF6B6B" text-anchor="middle">Causal Mask</text>

    <!-- 5x5 causal mask -->
    <g transform="translate(0, 15)">
      <!-- Row labels -->
      <text x="-15" y="25" font-family="monospace" font-size="10" fill="#888888" text-anchor="end">0</text>
      <text x="-15" y="55" font-family="monospace" font-size="10" fill="#888888" text-anchor="end">1</text>
      <text x="-15" y="85" font-family="monospace" font-size="10" fill="#888888" text-anchor="end">2</text>
      <text x="-15" y="115" font-family="monospace" font-size="10" fill="#888888" text-anchor="end">3</text>
      <text x="-15" y="145" font-family="monospace" font-size="10" fill="#888888" text-anchor="end">4</text>

      <!-- Col labels -->
      <text x="20" y="-5" font-family="monospace" font-size="10" fill="#888888" text-anchor="middle">0</text>
      <text x="60" y="-5" font-family="monospace" font-size="10" fill="#888888" text-anchor="middle">1</text>
      <text x="100" y="-5" font-family="monospace" font-size="10" fill="#888888" text-anchor="middle">2</text>
      <text x="140" y="-5" font-family="monospace" font-size="10" fill="#888888" text-anchor="middle">3</text>
      <text x="180" y="-5" font-family="monospace" font-size="10" fill="#888888" text-anchor="middle">4</text>

      <!-- Row 0: [✓][-][-][-][-] -->
      <rect x="0" y="5" width="40" height="30" fill="#83C167" fill-opacity="0.4" stroke="#83C167"/>
      <rect x="40" y="5" width="40" height="30" fill="#FF6B6B" fill-opacity="0.2" stroke="#444444"/>
      <rect x="80" y="5" width="40" height="30" fill="#FF6B6B" fill-opacity="0.2" stroke="#444444"/>
      <rect x="120" y="5" width="40" height="30" fill="#FF6B6B" fill-opacity="0.2" stroke="#444444"/>
      <rect x="160" y="5" width="40" height="30" fill="#FF6B6B" fill-opacity="0.2" stroke="#444444"/>

      <!-- Row 1: [✓][✓][-][-][-] -->
      <rect x="0" y="35" width="40" height="30" fill="#83C167" fill-opacity="0.4" stroke="#83C167"/>
      <rect x="40" y="35" width="40" height="30" fill="#83C167" fill-opacity="0.4" stroke="#83C167"/>
      <rect x="80" y="35" width="40" height="30" fill="#FF6B6B" fill-opacity="0.2" stroke="#444444"/>
      <rect x="120" y="35" width="40" height="30" fill="#FF6B6B" fill-opacity="0.2" stroke="#444444"/>
      <rect x="160" y="35" width="40" height="30" fill="#FF6B6B" fill-opacity="0.2" stroke="#444444"/>

      <!-- Row 2: [✓][✓][✓][-][-] -->
      <rect x="0" y="65" width="40" height="30" fill="#83C167" fill-opacity="0.4" stroke="#83C167"/>
      <rect x="40" y="65" width="40" height="30" fill="#83C167" fill-opacity="0.4" stroke="#83C167"/>
      <rect x="80" y="65" width="40" height="30" fill="#83C167" fill-opacity="0.4" stroke="#83C167"/>
      <rect x="120" y="65" width="40" height="30" fill="#FF6B6B" fill-opacity="0.2" stroke="#444444"/>
      <rect x="160" y="65" width="40" height="30" fill="#FF6B6B" fill-opacity="0.2" stroke="#444444"/>

      <!-- Row 3: [✓][✓][✓][✓][-] -->
      <rect x="0" y="95" width="40" height="30" fill="#83C167" fill-opacity="0.4" stroke="#83C167"/>
      <rect x="40" y="95" width="40" height="30" fill="#83C167" fill-opacity="0.4" stroke="#83C167"/>
      <rect x="80" y="95" width="40" height="30" fill="#83C167" fill-opacity="0.4" stroke="#83C167"/>
      <rect x="120" y="95" width="40" height="30" fill="#83C167" fill-opacity="0.4" stroke="#83C167"/>
      <rect x="160" y="95" width="40" height="30" fill="#FF6B6B" fill-opacity="0.2" stroke="#444444"/>

      <!-- Row 4: [✓][✓][✓][✓][✓] -->
      <rect x="0" y="125" width="40" height="30" fill="#83C167" fill-opacity="0.4" stroke="#83C167"/>
      <rect x="40" y="125" width="40" height="30" fill="#83C167" fill-opacity="0.4" stroke="#83C167"/>
      <rect x="80" y="125" width="40" height="30" fill="#83C167" fill-opacity="0.4" stroke="#83C167"/>
      <rect x="120" y="125" width="40" height="30" fill="#83C167" fill-opacity="0.4" stroke="#83C167"/>
      <rect x="160" y="125" width="40" height="30" fill="#83C167" fill-opacity="0.4" stroke="#83C167"/>
    </g>

    <text x="100" y="185" font-family="CMU Serif, Georgia, serif" font-size="11" fill="#83C167" text-anchor="middle">✓ can attend</text>
    <text x="100" y="200" font-family="CMU Serif, Georgia, serif" font-size="11" fill="#FF6B6B" text-anchor="middle">✗ cannot (future)</text>
  </g>

  <!-- ============ Cumsum State Accumulation ============ -->
  <g transform="translate(300, 90)">
    <text x="250" y="-5" font-family="CMU Serif, Georgia, serif" font-size="16" fill="#FFFF00" text-anchor="middle">Cumulative State S</text>

    <!-- State evolution diagram -->
    <g transform="translate(0, 20)">
      <!-- Position 0 -->
      <g transform="translate(0, 0)">
        <text x="0" y="0" font-family="monospace" font-size="11" fill="#888888">i=0:</text>
        <rect x="40" y="-15" width="60" height="25" fill="#29ABCA" fill-opacity="0.3" stroke="#29ABCA" rx="3"/>
        <text x="70" y="3" font-family="monospace" font-size="10" fill="#29ABCA" text-anchor="middle">k₀⊗v₀</text>
        <text x="115" y="3" font-family="monospace" font-size="10" fill="#888888">=</text>
        <rect x="130" y="-15" width="40" height="25" fill="#FFFF00" fill-opacity="0.3" stroke="#FFFF00" rx="3"/>
        <text x="150" y="3" font-family="monospace" font-size="10" fill="#FFFF00" text-anchor="middle">S₀</text>
      </g>

      <!-- Position 1 -->
      <g transform="translate(0, 40)">
        <text x="0" y="0" font-family="monospace" font-size="11" fill="#888888">i=1:</text>
        <rect x="40" y="-15" width="40" height="25" fill="#FFFF00" fill-opacity="0.2" stroke="#FFFF00" stroke-dasharray="3,2" rx="3"/>
        <text x="60" y="3" font-family="monospace" font-size="10" fill="#FFFF00" text-anchor="middle">S₀</text>
        <text x="90" y="3" font-family="monospace" font-size="10" fill="#888888">+</text>
        <rect x="105" y="-15" width="60" height="25" fill="#29ABCA" fill-opacity="0.3" stroke="#29ABCA" rx="3"/>
        <text x="135" y="3" font-family="monospace" font-size="10" fill="#29ABCA" text-anchor="middle">k₁⊗v₁</text>
        <text x="180" y="3" font-family="monospace" font-size="10" fill="#888888">=</text>
        <rect x="195" y="-15" width="40" height="25" fill="#FFFF00" fill-opacity="0.4" stroke="#FFFF00" rx="3"/>
        <text x="215" y="3" font-family="monospace" font-size="10" fill="#FFFF00" text-anchor="middle">S₁</text>
      </g>

      <!-- Position 2 -->
      <g transform="translate(0, 80)">
        <text x="0" y="0" font-family="monospace" font-size="11" fill="#888888">i=2:</text>
        <rect x="40" y="-15" width="40" height="25" fill="#FFFF00" fill-opacity="0.3" stroke="#FFFF00" stroke-dasharray="3,2" rx="3"/>
        <text x="60" y="3" font-family="monospace" font-size="10" fill="#FFFF00" text-anchor="middle">S₁</text>
        <text x="90" y="3" font-family="monospace" font-size="10" fill="#888888">+</text>
        <rect x="105" y="-15" width="60" height="25" fill="#29ABCA" fill-opacity="0.3" stroke="#29ABCA" rx="3"/>
        <text x="135" y="3" font-family="monospace" font-size="10" fill="#29ABCA" text-anchor="middle">k₂⊗v₂</text>
        <text x="180" y="3" font-family="monospace" font-size="10" fill="#888888">=</text>
        <rect x="195" y="-15" width="40" height="25" fill="#FFFF00" fill-opacity="0.5" stroke="#FFFF00" rx="3"/>
        <text x="215" y="3" font-family="monospace" font-size="10" fill="#FFFF00" text-anchor="middle">S₂</text>
      </g>

      <!-- Position 3 -->
      <g transform="translate(0, 120)">
        <text x="0" y="0" font-family="monospace" font-size="11" fill="#888888">i=3:</text>
        <rect x="40" y="-15" width="40" height="25" fill="#FFFF00" fill-opacity="0.4" stroke="#FFFF00" stroke-dasharray="3,2" rx="3"/>
        <text x="60" y="3" font-family="monospace" font-size="10" fill="#FFFF00" text-anchor="middle">S₂</text>
        <text x="90" y="3" font-family="monospace" font-size="10" fill="#888888">+</text>
        <rect x="105" y="-15" width="60" height="25" fill="#29ABCA" fill-opacity="0.3" stroke="#29ABCA" rx="3"/>
        <text x="135" y="3" font-family="monospace" font-size="10" fill="#29ABCA" text-anchor="middle">k₃⊗v₃</text>
        <text x="180" y="3" font-family="monospace" font-size="10" fill="#888888">=</text>
        <rect x="195" y="-15" width="40" height="25" fill="#FFFF00" fill-opacity="0.6" stroke="#FFFF00" rx="3"/>
        <text x="215" y="3" font-family="monospace" font-size="10" fill="#FFFF00" text-anchor="middle">S₃</text>
      </g>

      <!-- Explanation -->
      <text x="250" y="160" font-family="CMU Serif, Georgia, serif" font-size="11" fill="#888888">State grows as</text>
      <text x="250" y="175" font-family="CMU Serif, Georgia, serif" font-size="11" fill="#888888">cumulative sum</text>
    </g>

    <!-- Query retrieval -->
    <g transform="translate(300, 20)">
      <text x="100" y="-5" font-family="CMU Serif, Georgia, serif" font-size="14" fill="#83C167" text-anchor="middle">Query Retrieval</text>

      <g transform="translate(0, 20)">
        <text x="0" y="0" font-family="CMU Serif, Georgia, serif" font-size="11" fill="#888888">Output at i:</text>
        <text x="0" y="25" font-family="monospace" font-size="12" fill="#83C167">out_i = q_i · S_i / (q_i · Z_i)</text>
      </g>

      <g transform="translate(0, 70)">
        <text x="0" y="0" font-family="CMU Serif, Georgia, serif" font-size="11" fill="#888888">where:</text>
        <text x="0" y="20" font-family="monospace" font-size="10" fill="#FFFF00">S_i = Σ_{j≤i} φ(k_j) ⊗ v_j</text>
        <text x="0" y="40" font-family="monospace" font-size="10" fill="#FFFF00">Z_i = Σ_{j≤i} φ(k_j)</text>
      </g>

      <g transform="translate(0, 130)">
        <rect x="0" y="0" width="200" height="50" fill="#111111" stroke="#444444" rx="3"/>
        <text x="100" y="20" font-family="CMU Serif, Georgia, serif" font-size="11" fill="#83C167" text-anchor="middle">Use np.cumsum!</text>
        <text x="100" y="38" font-family="CMU Serif, Georgia, serif" font-size="10" fill="#888888" text-anchor="middle">Computes all S_i in O(n)</text>
      </g>
    </g>
  </g>

  <!-- ============ Two Modes Comparison ============ -->
  <g transform="translate(50, 340)">
    <text x="400" y="0" font-family="CMU Serif, Georgia, serif" font-size="18" fill="#ffffff" text-anchor="middle">Two Modes: Training vs Inference</text>

    <!-- Training (Parallel) -->
    <g transform="translate(30, 35)">
      <rect x="0" y="0" width="350" height="120" fill="#29ABCA" fill-opacity="0.1" stroke="#29ABCA" rx="5"/>
      <text x="175" y="25" font-family="CMU Serif, Georgia, serif" font-size="14" fill="#29ABCA" text-anchor="middle">Parallel Form (Training)</text>

      <text x="20" y="50" font-family="monospace" font-size="11" fill="#888888">kv_cumsum = cumsum(K⊗V, axis=0)</text>
      <text x="20" y="70" font-family="monospace" font-size="11" fill="#888888">output = Q @ kv_cumsum / normalizer</text>

      <text x="175" y="100" font-family="CMU Serif, Georgia, serif" font-size="11" fill="#29ABCA" text-anchor="middle">✓ All positions computed in parallel</text>
    </g>

    <!-- Inference (Recurrent) -->
    <g transform="translate(420, 35)">
      <rect x="0" y="0" width="350" height="120" fill="#83C167" fill-opacity="0.1" stroke="#83C167" rx="5"/>
      <text x="175" y="25" font-family="CMU Serif, Georgia, serif" font-size="14" fill="#83C167" text-anchor="middle">Recurrent Form (Inference)</text>

      <text x="20" y="50" font-family="monospace" font-size="11" fill="#888888">S = S + φ(k_i) ⊗ v_i</text>
      <text x="20" y="70" font-family="monospace" font-size="11" fill="#888888">output_i = q_i @ S / (q_i @ Z)</text>

      <text x="175" y="100" font-family="CMU Serif, Georgia, serif" font-size="11" fill="#83C167" text-anchor="middle">✓ O(1) per new token (vs O(n) for softmax!)</text>
    </g>
  </g>

  <!-- Key advantage -->
  <g transform="translate(50, 495)">
    <rect x="0" y="0" width="800" height="40" fill="#111111" stroke="#FFFF00" rx="5"/>
    <text x="400" y="25" font-family="CMU Serif, Georgia, serif" font-size="13" fill="#FFFF00" text-anchor="middle">
      Key Advantage: State S replaces KV-cache — No recomputation needed for new tokens!
    </text>
  </g>
</svg>
