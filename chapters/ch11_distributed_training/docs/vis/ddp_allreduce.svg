<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 900 550">
  <!-- Pure black background -->
  <rect width="900" height="550" fill="#000000"/>

  <!-- Title -->
  <text x="450" y="40" font-family="CMU Serif, Georgia, serif" font-size="26" fill="#ffffff" text-anchor="middle">DDP: All-Reduce Gradient Synchronization</text>

  <!-- Subtitle -->
  <text x="450" y="68" font-family="CMU Serif, Georgia, serif" font-size="14" fill="#888888" text-anchor="middle">
    Each GPU computes gradients on its data, then all-reduce averages them
  </text>

  <!-- ============ Step 1: Forward Pass ============ -->
  <g transform="translate(50, 100)">
    <text x="120" y="0" font-family="CMU Serif, Georgia, serif" font-size="16" fill="#29ABCA" text-anchor="middle">1. Forward Pass (parallel)</text>

    <!-- GPU 0 -->
    <g transform="translate(0, 25)">
      <rect x="0" y="0" width="75" height="80" rx="4" fill="none" stroke="#29ABCA" stroke-width="2"/>
      <text x="37" y="18" font-family="CMU Serif, Georgia, serif" font-size="11" fill="#29ABCA" text-anchor="middle">GPU 0</text>

      <!-- Data -->
      <rect x="8" y="25" width="60" height="20" rx="2" fill="#FFFF00" fill-opacity="0.2" stroke="#FFFF00"/>
      <text x="38" y="39" font-family="monospace" font-size="9" fill="#FFFF00" text-anchor="middle">batch₀</text>

      <!-- Model -->
      <rect x="8" y="50" width="60" height="22" rx="2" fill="#29ABCA" fill-opacity="0.3" stroke="#29ABCA"/>
      <text x="38" y="65" font-family="monospace" font-size="9" fill="#29ABCA" text-anchor="middle">Model</text>
    </g>

    <!-- GPU 1 -->
    <g transform="translate(85, 25)">
      <rect x="0" y="0" width="75" height="80" rx="4" fill="none" stroke="#29ABCA" stroke-width="2"/>
      <text x="37" y="18" font-family="CMU Serif, Georgia, serif" font-size="11" fill="#29ABCA" text-anchor="middle">GPU 1</text>

      <rect x="8" y="25" width="60" height="20" rx="2" fill="#FFFF00" fill-opacity="0.2" stroke="#FFFF00"/>
      <text x="38" y="39" font-family="monospace" font-size="9" fill="#FFFF00" text-anchor="middle">batch₁</text>

      <rect x="8" y="50" width="60" height="22" rx="2" fill="#29ABCA" fill-opacity="0.3" stroke="#29ABCA"/>
      <text x="38" y="65" font-family="monospace" font-size="9" fill="#29ABCA" text-anchor="middle">Model</text>
    </g>

    <!-- GPU 2 -->
    <g transform="translate(170, 25)">
      <rect x="0" y="0" width="75" height="80" rx="4" fill="none" stroke="#29ABCA" stroke-width="2"/>
      <text x="37" y="18" font-family="CMU Serif, Georgia, serif" font-size="11" fill="#29ABCA" text-anchor="middle">GPU 2</text>

      <rect x="8" y="25" width="60" height="20" rx="2" fill="#FFFF00" fill-opacity="0.2" stroke="#FFFF00"/>
      <text x="38" y="39" font-family="monospace" font-size="9" fill="#FFFF00" text-anchor="middle">batch₂</text>

      <rect x="8" y="50" width="60" height="22" rx="2" fill="#29ABCA" fill-opacity="0.3" stroke="#29ABCA"/>
      <text x="38" y="65" font-family="monospace" font-size="9" fill="#29ABCA" text-anchor="middle">Model</text>
    </g>

    <!-- Arrows down to loss -->
    <line x1="37" y1="105" x2="37" y2="125" stroke="#666666" stroke-width="1.5"/>
    <line x1="122" y1="105" x2="122" y2="125" stroke="#666666" stroke-width="1.5"/>
    <line x1="207" y1="105" x2="207" y2="125" stroke="#666666" stroke-width="1.5"/>

    <!-- Loss -->
    <text x="37" y="140" font-family="monospace" font-size="10" fill="#FF6B6B" text-anchor="middle">loss₀</text>
    <text x="122" y="140" font-family="monospace" font-size="10" fill="#FF6B6B" text-anchor="middle">loss₁</text>
    <text x="207" y="140" font-family="monospace" font-size="10" fill="#FF6B6B" text-anchor="middle">loss₂</text>
  </g>

  <!-- ============ Step 2: Backward Pass ============ -->
  <g transform="translate(320, 100)">
    <text x="120" y="0" font-family="CMU Serif, Georgia, serif" font-size="16" fill="#FF6B6B" text-anchor="middle">2. Backward Pass (parallel)</text>

    <!-- Gradient boxes -->
    <g transform="translate(0, 25)">
      <rect x="0" y="0" width="75" height="80" rx="4" fill="none" stroke="#FF6B6B" stroke-width="2"/>
      <text x="37" y="18" font-family="CMU Serif, Georgia, serif" font-size="11" fill="#FF6B6B" text-anchor="middle">GPU 0</text>
      <rect x="8" y="28" width="60" height="44" rx="2" fill="#FF6B6B" fill-opacity="0.2" stroke="#FF6B6B"/>
      <text x="38" y="45" font-family="monospace" font-size="9" fill="#FF6B6B" text-anchor="middle">∇₀ = [a,b,c]</text>
      <text x="38" y="60" font-family="CMU Serif, Georgia, serif" font-size="8" fill="#666666" text-anchor="middle">local gradients</text>
    </g>

    <g transform="translate(85, 25)">
      <rect x="0" y="0" width="75" height="80" rx="4" fill="none" stroke="#FF6B6B" stroke-width="2"/>
      <text x="37" y="18" font-family="CMU Serif, Georgia, serif" font-size="11" fill="#FF6B6B" text-anchor="middle">GPU 1</text>
      <rect x="8" y="28" width="60" height="44" rx="2" fill="#FF6B6B" fill-opacity="0.2" stroke="#FF6B6B"/>
      <text x="38" y="45" font-family="monospace" font-size="9" fill="#FF6B6B" text-anchor="middle">∇₁ = [d,e,f]</text>
      <text x="38" y="60" font-family="CMU Serif, Georgia, serif" font-size="8" fill="#666666" text-anchor="middle">local gradients</text>
    </g>

    <g transform="translate(170, 25)">
      <rect x="0" y="0" width="75" height="80" rx="4" fill="none" stroke="#FF6B6B" stroke-width="2"/>
      <text x="37" y="18" font-family="CMU Serif, Georgia, serif" font-size="11" fill="#FF6B6B" text-anchor="middle">GPU 2</text>
      <rect x="8" y="28" width="60" height="44" rx="2" fill="#FF6B6B" fill-opacity="0.2" stroke="#FF6B6B"/>
      <text x="38" y="45" font-family="monospace" font-size="9" fill="#FF6B6B" text-anchor="middle">∇₂ = [g,h,i]</text>
      <text x="38" y="60" font-family="CMU Serif, Georgia, serif" font-size="8" fill="#666666" text-anchor="middle">local gradients</text>
    </g>
  </g>

  <!-- ============ Step 3: All-Reduce ============ -->
  <g transform="translate(590, 100)">
    <text x="140" y="0" font-family="CMU Serif, Georgia, serif" font-size="16" fill="#83C167" text-anchor="middle">3. All-Reduce</text>

    <!-- Before state -->
    <g transform="translate(0, 25)">
      <text x="70" y="10" font-family="CMU Serif, Georgia, serif" font-size="11" fill="#666666" text-anchor="middle">Before</text>

      <rect x="0" y="18" width="45" height="25" rx="2" fill="#FF6B6B" fill-opacity="0.2" stroke="#FF6B6B"/>
      <text x="22" y="35" font-family="monospace" font-size="8" fill="#FF6B6B" text-anchor="middle">[a,b,c]</text>

      <rect x="48" y="18" width="45" height="25" rx="2" fill="#FF6B6B" fill-opacity="0.2" stroke="#FF6B6B"/>
      <text x="70" y="35" font-family="monospace" font-size="8" fill="#FF6B6B" text-anchor="middle">[d,e,f]</text>

      <rect x="96" y="18" width="45" height="25" rx="2" fill="#FF6B6B" fill-opacity="0.2" stroke="#FF6B6B"/>
      <text x="118" y="35" font-family="monospace" font-size="8" fill="#FF6B6B" text-anchor="middle">[g,h,i]</text>
    </g>

    <!-- Ring arrows -->
    <g transform="translate(150, 45)">
      <circle cx="0" cy="30" r="25" fill="none" stroke="#83C167" stroke-width="2" stroke-dasharray="4,2"/>
      <text x="0" y="35" font-family="CMU Serif, Georgia, serif" font-size="10" fill="#83C167" text-anchor="middle">Ring</text>

      <!-- Arrows around ring -->
      <path d="M 20,15 A 25,25 0 0,1 20,45" fill="none" stroke="#83C167" stroke-width="2"/>
      <polygon points="20,45 15,38 23,40" fill="#83C167"/>
    </g>

    <!-- After state -->
    <g transform="translate(0, 85)">
      <text x="140" y="10" font-family="CMU Serif, Georgia, serif" font-size="11" fill="#83C167" text-anchor="middle">After: All GPUs have averaged gradients</text>

      <rect x="0" y="20" width="90" height="30" rx="2" fill="#83C167" fill-opacity="0.2" stroke="#83C167" stroke-width="2"/>
      <text x="45" y="40" font-family="monospace" font-size="9" fill="#83C167" text-anchor="middle">(∇₀+∇₁+∇₂)/3</text>

      <rect x="95" y="20" width="90" height="30" rx="2" fill="#83C167" fill-opacity="0.2" stroke="#83C167" stroke-width="2"/>
      <text x="140" y="40" font-family="monospace" font-size="9" fill="#83C167" text-anchor="middle">(∇₀+∇₁+∇₂)/3</text>

      <rect x="190" y="20" width="90" height="30" rx="2" fill="#83C167" fill-opacity="0.2" stroke="#83C167" stroke-width="2"/>
      <text x="235" y="40" font-family="monospace" font-size="9" fill="#83C167" text-anchor="middle">(∇₀+∇₁+∇₂)/3</text>

      <text x="45" y="60" font-family="CMU Serif, Georgia, serif" font-size="9" fill="#666666" text-anchor="middle">GPU 0</text>
      <text x="140" y="60" font-family="CMU Serif, Georgia, serif" font-size="9" fill="#666666" text-anchor="middle">GPU 1</text>
      <text x="235" y="60" font-family="CMU Serif, Georgia, serif" font-size="9" fill="#666666" text-anchor="middle">GPU 2</text>
    </g>
  </g>

  <!-- ============ Ring All-Reduce Detail ============ -->
  <g transform="translate(50, 320)">
    <text x="400" y="0" font-family="CMU Serif, Georgia, serif" font-size="20" fill="#ffffff" text-anchor="middle">Ring All-Reduce: How It Works</text>

    <!-- Ring topology -->
    <g transform="translate(50, 30)">
      <text x="100" y="10" font-family="CMU Serif, Georgia, serif" font-size="14" fill="#888888" text-anchor="middle">Ring Topology</text>

      <!-- Four GPUs in a ring -->
      <rect x="70" y="25" width="60" height="35" rx="4" fill="none" stroke="#29ABCA" stroke-width="2"/>
      <text x="100" y="48" font-family="monospace" font-size="10" fill="#29ABCA" text-anchor="middle">GPU 0</text>

      <rect x="145" y="70" width="60" height="35" rx="4" fill="none" stroke="#29ABCA" stroke-width="2"/>
      <text x="175" y="93" font-family="monospace" font-size="10" fill="#29ABCA" text-anchor="middle">GPU 1</text>

      <rect x="70" y="115" width="60" height="35" rx="4" fill="none" stroke="#29ABCA" stroke-width="2"/>
      <text x="100" y="138" font-family="monospace" font-size="10" fill="#29ABCA" text-anchor="middle">GPU 3</text>

      <rect x="-5" y="70" width="60" height="35" rx="4" fill="none" stroke="#29ABCA" stroke-width="2"/>
      <text x="25" y="93" font-family="monospace" font-size="10" fill="#29ABCA" text-anchor="middle">GPU 2</text>

      <!-- Arrows -->
      <line x1="130" y1="42" x2="150" y2="70" stroke="#83C167" stroke-width="2" marker-end="url(#arrowhead)"/>
      <line x1="175" y1="105" x2="130" y2="125" stroke="#83C167" stroke-width="2"/>
      <line x1="70" y1="132" x2="50" y2="105" stroke="#83C167" stroke-width="2"/>
      <line x1="25" y1="70" x2="70" y2="50" stroke="#83C167" stroke-width="2"/>

      <!-- Arrow markers -->
      <defs>
        <marker id="arrowhead" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto">
          <polygon points="0,0 6,3 0,6" fill="#83C167"/>
        </marker>
      </defs>
    </g>

    <!-- Bandwidth explanation -->
    <g transform="translate(300, 30)">
      <text x="200" y="10" font-family="CMU Serif, Georgia, serif" font-size="14" fill="#888888" text-anchor="middle">Bandwidth Efficiency</text>

      <!-- Naive all-to-all -->
      <g transform="translate(0, 30)">
        <text x="0" y="0" font-family="CMU Serif, Georgia, serif" font-size="12" fill="#FF6B6B">Naive All-to-All:</text>
        <text x="0" y="18" font-family="monospace" font-size="11" fill="#666666">Each GPU sends to all others</text>
        <text x="0" y="35" font-family="monospace" font-size="11" fill="#666666">Data sent: N × (N-1) × model_size</text>
        <text x="0" y="52" font-family="monospace" font-size="11" fill="#FF6B6B">= O(N²) communication</text>
      </g>

      <!-- Ring all-reduce -->
      <g transform="translate(0, 95)">
        <text x="0" y="0" font-family="CMU Serif, Georgia, serif" font-size="12" fill="#83C167">Ring All-Reduce:</text>
        <text x="0" y="18" font-family="monospace" font-size="11" fill="#666666">Each GPU sends to one neighbor</text>
        <text x="0" y="35" font-family="monospace" font-size="11" fill="#666666">Data sent: 2 × model_size</text>
        <text x="0" y="52" font-family="monospace" font-size="11" fill="#83C167">= O(1) regardless of N!</text>
      </g>
    </g>

    <!-- Key insight -->
    <g transform="translate(600, 30)">
      <rect x="0" y="0" width="230" height="140" rx="6" fill="#333333" stroke="#83C167" stroke-width="1"/>
      <text x="115" y="25" font-family="CMU Serif, Georgia, serif" font-size="14" fill="#83C167" text-anchor="middle">Key Insight</text>

      <text x="15" y="50" font-family="CMU Serif, Georgia, serif" font-size="11" fill="#ffffff">Ring all-reduce splits data into</text>
      <text x="15" y="68" font-family="CMU Serif, Georgia, serif" font-size="11" fill="#ffffff">chunks. Each GPU:</text>

      <text x="25" y="90" font-family="CMU Serif, Georgia, serif" font-size="11" fill="#FFFF00">1. Reduce-Scatter phase:</text>
      <text x="35" y="105" font-family="CMU Serif, Georgia, serif" font-size="10" fill="#888888">Each gets sum of 1/N chunks</text>

      <text x="25" y="125" font-family="CMU Serif, Georgia, serif" font-size="11" fill="#FFFF00">2. All-Gather phase:</text>
      <text x="35" y="140" font-family="CMU Serif, Georgia, serif" font-size="10" fill="#888888">Broadcast complete result</text>
    </g>
  </g>

  <!-- Footer -->
  <text x="450" y="525" font-family="CMU Serif, Georgia, serif" font-size="12" fill="#666666" text-anchor="middle">
    DDP handles all-reduce automatically during loss.backward()
  </text>
</svg>